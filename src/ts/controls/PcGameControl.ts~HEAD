import * as THREE from 'three';
import {IPlayerContol} from './IPlayerControl';

// 参考实现:
// https://zhuanlan.zhihu.com/p/40881782
// https://github.com/mrdoob/three.js/blob/master/examples/js/controls/FirstPersonControls.js

<<<<<<< HEAD:src/ts/controls/PcGameControl.ts
enum MoveDirection{
    NotMove,
    Forward,
    Backward,
    Left,
    Right
}

class PcGameControl implements IPlayerContol {
=======
class PcPlayerContol implements IPlayerContol {
>>>>>>> parent of 749712c... 定义枚举MoveDirection表示移动方向:src/ts/controls/PcPlayerControl.ts

    object: THREE.Camera;

    domElement: HTMLElement | HTMLDocument;

    enable: boolean;

    constructor(object: THREE.Camera, domElement?: HTMLDocument) {
        this.domElement = domElement || document;
        this.object = object;

        this.domElement.addEventListener('mousedown', this.onMouseDown, false);
        this.domElement.addEventListener('mousemove', this.onMouseMove, false);
        this.domElement.addEventListener('mouseup', this.onMouseUp, false);
        this.domElement.addEventListener('keydown', this.onKeyDown, false);
        this.domElement.addEventListener('keyup', this.onKeyUp, false);
    }

    //鼠标上下左右转动

    lastX: number;
    lastY: number;

    xDelta: number = 0;
    yDelta: number = 0;

    hSpeed: number = 0.1;
    vSpeed: number = 0.1;

    isDrag: boolean = false;

    onMouseDown = (e: MouseEvent) => {
        e.preventDefault();
        e.stopPropagation();

        this.isDrag = true;
        this.lastX = e.pageX;
        this.lastY = e.pageY;
    }

    onMouseMove = (e: MouseEvent) => {
        e.preventDefault();
        e.stopPropagation();

        if (!this.isDrag) return;

        this.xDelta += (e.pageX - this.lastX) * this.hSpeed;
        this.yDelta += (e.pageY - this.lastY) * this.vSpeed;
        this.lastX = e.pageX;
        this.lastY = e.pageY;       
    }

    onMouseUp = (e: MouseEvent) => {
        this.isDrag = false;
    }

    //键盘前后左右移动

    moveForward: boolean;
    moveBackward: boolean;

    moveLeft: boolean;
    moveRight: boolean;

    onKeyDown = (event: KeyboardEvent) => {

        //event.preventDefault();

        switch (event.keyCode) {

            case 38: /*up*/
            case 87: /*W*/ this.moveForward = true; break;

            case 37: /*left*/
            case 65: /*A*/ this.moveLeft = true; break;

            case 40: /*down*/
            case 83: /*S*/ this.moveBackward = true; break;

            case 39: /*right*/
            case 68: /*D*/ this.moveRight = true; break;

        }

    };

    onKeyUp = (event: KeyboardEvent) => {

        switch (event.keyCode) {

            case 38: /*up*/
            case 87: /*W*/ this.moveForward = false; break;

            case 37: /*left*/
            case 65: /*A*/ this.moveLeft = false; break;

            case 40: /*down*/
            case 83: /*S*/ this.moveBackward = false; break;

            case 39: /*right*/
            case 68: /*D*/ this.moveRight = false; break;

        }

    };

    moveSpeed:number = 4000;

    update = (delta: number) => {

        if(this.moveForward) {
            if(this.object.position.z >= -14000)
                this.object.translateZ(-this.moveSpeed * delta);
        }

        if(this.moveBackward){ 
            if(this.object.position.z <= 19000)
                  this.object.translateZ(this.moveSpeed * delta);
        }

        if(this.moveLeft) {
            if(this.object.position.x >= -14000)
                this.object.translateX(-this.moveSpeed * delta);
        }

        if(this.moveRight) {
            if(this.object.position.x <= 17400)
                 this.object.translateX(this.moveSpeed * delta);
        }

       // if (!this.isDrag) return;

        this.object.rotation.y = THREE.Math.degToRad(this.xDelta);
        // this.object.rotation.x = THREE.Math.degToRad(this.yDelta);

    }
}


export {PcGameControl};